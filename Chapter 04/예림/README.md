# 4장. 외부 연동이 문제일 때 살펴봐야 할 것들
## 우리는 문제가 없는데
- 한 서비스의 장애는 연동된 서비스로 번짐

## 타임아웃
- 문제 악화 상황
  - A -> B 서비스 요청인데 B 서비스가 처리를 못해서 A 서비스에 B와 관련 없는 요청이 와도 처리 못함
  - 새로고침 해도 앞서 사용자가 보낸 요청을 여전히 처리 중
- 타임아웃을 설정하면 사용자는 타임아웃으로 지정한 시간 뒤에 에러 화면을 보게 됨
  - 무한 대기보다는 이게 나음

 ### 2가지 타임아웃 : 연결타임아웃, 읽기 타임아웃
 - 처음 연동하는 서비스라면 타임아웃 시간을 아래와 같이 설정한 뒤, 추이를 보면서 조정하는 게 좋음
   - 연결 타임아웃 : 3초 ~ 5초
   - 읽기 타임아웃 : 5초 ~ 30초
- 결제처럼 민감한 기능은 타임아웃 시간 길게 설정

## 재시도
### 재시도 가능 조건
- 단순 조회 기능
  - 재시도를 통해 성공확률 UP
- 연결 타임아웃
  - 재시도를 통해 성공확률 UP
- 멱등성을 가진 변경 기능
  - 읽기 타임아웃은 재시도할 때 주의해야 한다. 중복이 발생할 수 있음. 멱등성을 고려해야 함
  - 멱등성 : 연산을 여러 번 적용해도 결과가 달라지지 않는 성질
  
### 재시도 횟수와 간격
- 재시도 시 다음 2가지를 결정해야 함
  - 재시도 횟수
    - 대부분 1~2번이 적당 (3번 시도 실패했다면 다른 문제일 가능성 높음)
  - 재시도 간격
    - 간격을 두고 재시도 하면 일시적인 네트워크 문제가 해소되면서 재시도 성공 확률 높아짐
      
      <img width="480" height="127" alt="스크린샷 2026-01-09 오후 9 44 01" src="https://github.com/user-attachments/assets/c232b9b1-025e-4ccf-906d-11428135a25f" />

### 재시도 폭풍 (retry storm) 안티 패턴
- 재시도 시 연동 서비스는 같은 요청을 두 배로 받게 됨
- 더 큰 부하를 줄 수 있으므로 연동 서비스의 성능 상황도 함께 고려 해야 함

## 동시 요청 제한
- 성능 저하 문제 완화 방법 : 일정 수준 이상 요청을 받지 않고 에러 응답
  <img width="435" height="133" alt="스크린샷 2026-01-11 오후 3 08 21" src="https://github.com/user-attachments/assets/1c03a304-8d99-4f79-9acc-ee28281eba08" />
  - `벌크 헤드 패턴` : 각 구성 요소를 격리함으로써 한 구성 요소의 장애가 다른 구성 요소에 영향을 주지 않도록 하는 설계 패턴

## 서킷 브레이커
- 서킷 브레이커 : 과전류가 흐르면 차단기가 내려가 전기를 끊는 것처럼, 서킷 브레이커도 과도한 오류가 발생하면 연동을 중지시키고 바로 에러를 응답한다.
- 3가지 상태
  - `닫힘` - 모든 요청 전달 
  - `열림` - 요청 수행 x 에러 응답
  - `반 열림` - 일부 요청에 한해 욘동 시도
  <img width="365" height="123" alt="스크린샷 2026-01-14 오후 11 07 24" src="https://github.com/user-attachments/assets/f63b434e-5469-419e-b707-34660c98f0b0" />

- `닫힘` -> 오류 발생 -> 임계치 초과했는지 확인 -> 초과했으면 `열림` 상태 -> 지정된 시간이 지난 후 `반 열림` 상태 -> 일정 시간이 지난 후 `닫힘` 상태로 복귀
  - 임계치
    - 시간 기준
    - 개수 기준
- 빠른 실패(fast fail)
## 외부 연동과 DB 연동
### 외부 연동과 트랜잭션 처리
- 흔히 발생하는 2가지 상황
  1. 외부 연동 실패 -> 롤백
    
  2. 외부 연동 성공 BUT DB 연동 실패 -> 롤백

- 외부 연동 실패 -> 롤백
  - 롤백했는데 외부 서비스는 성공할 경우 -> 2가지 방법 존배
    - 일정 주기로 두 시스템 데이터 일치하는지 확인하고 보정
    - 성공 확인 API 호출
      - 변형으로 취소 API를 호출하는 방법도 있음
      - BUT 연동 서비스가 지원을 해줘야 함

- 외부 연동은 성공 BUT DB 연동 실패
  - 취소 API를 호출해 외부 연동을 이전 상태로 되돌리는 것이 필요

### 외부 연동이 느려질 때 DB 커넥션 풀 문제
- DB 쿼리를 실행하지 않아도 외부 연동 때문에 커넥션 부족 현상이 발생할 수 있다
- DB 커넥션을 사용하기 전이나 후에 외부 연동 시도
  - 단, 트랜잭션 커밋 이후 외부 연동에 실패하면 롤백이 불가능
