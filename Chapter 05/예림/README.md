# 5장. 비동기 연동, 언제 어떻게 써야 할까

## 동기 연동과 비동기 연동
- 동기 연동 시 고려할 점
    - 외부 연동 실패가 전체 기능의 실패인지 고려
        - 로그인 후 포인트 지급 실패 시 로그인에도 실패하게 되어 있다면 기록을 남기는 방식으로 코드 작성
    - 외부 서비스의 응답 시간
      - 연동 서비스의 응답 시간 ⬆️ -> 응답 시간 ⬆️
      - 반드시 외부 연동 결과가 필요한 게 아니라면 비동기 방식 연동 고려
          - 포인트 지급이 끝날 때까지 기다리지 않고 로그인 성공 응답


- 비동기 사용 시 문제가 되지 않는 경우
  - 연동에 약간의 시차가 생겨도 문제가 되지 않음
  - 일부 기능은 실패 시 재시도 가능
  - 연동 실패 시 나중에 수동으로 처리 가능
  - 연동에 실패해도 무시해도 됨
- 예시
  - 푸시 서비스
  - 포인트 서비스
  - 검색 서비스 (컨텐츠 등록 시 검색 서비스에도 등록)
  - SMS 발송 서비스 연동 (인증 번호 요청 시 SMS로 인증 메시지 발송)
## 별도 스레드로 실행하기
- 비동기 연동을 하는 가장 쉬운 방법? 별도 스레드로 실행하기
- 스레드를 생성하거나, 스레드 풀을 사용하거나 스프링이 제공하는 @Async 이용

  - @Async 사용 시 메서드 이름에 비동기 메서드임을 알 수 있도록 async를 넣는 게 좋음
- 비동기로 실행되는 코드는 연동 과정에서 발생하는 오류를 직접 처리해야 한다.
## 메시징
- 서로 다른 시스템 간 비동기로 연동할 때 주로 사용하는 방식은 메시징 시스템을 사용하는 것
- 직접 호출하는 것보다 좋은 점
  - 두 시스템이 서로 영향을 주지 않음
    - 시스템 A -> 메시징 시스템 -> 시스템 B
    - 메시징 시스템은 A가 보낸 메시지 일단 저장하고 B의 성능에 맞게 메시지 전달
      - 즉 보관 역할도 함
  - 확장이 용이하다
    - 시스템 A -> 메시징 시스템 -> 시스템 C
    - A가 C에게 직접 데이터를 전송한다면 A에 코드를 추가헤야 함
    - 메시징 시스템을 사용하면 메시징 시스템을 C에 연결해주면 됨
- 메시징 시스템으로 많이 사용되는 기술
  - 카프카, 래핏 MQ, 레디스

### 메시지 생성 측 고려 사항
- 고려할 점 : 메시지 유실
- 타임 아웃 문제
  - 해결방안 :
    - `무시` - 제일 쉽지만 메시지 유실됨
    - `재시도` - 중복된 메시지 전송 가능
      - 중복 메시지 방지 시 메시지마다 고유 식별자 사용 추천
    - `실패 로그`
- 메시지 전송 후 DB 트랜잭션 롤백되면 잘못된 메시지 전송 가능
  - 트랜잭션이 끝난 뒤에 메시지를 전송해야 함
  - `글로벌 트랜잭션`을 지원하는 메시징 시스템도 있음 - 액티브 MQ
    - 글로벌 트랜잭션 : 여러 자원(여러 DB)에 대한 변경을 한 트랜잭션으로 묶어서 처리 가능
    - 꼭 필요한 상황 아니면 DB 처리와 메시지 전송 함께 묶지 말고 `트랜잭션 아웃박스 패턴`을 고려해보자

### 메시지 소비 측 고려 사항
- 메시지 소비자가 동일 메시지를 중복해서 처리할 수 있는 이유

  
  (1) 메시지 생산자가 같은 데이터를 가진 메시지를 메시징 시스템에 두 번 전송

  (2) 소비자가 데이터 처리하다가 오류 발생해서 재전송

- (1)의 경우 고유 ID 부여하면 됨
    ```java
    if (checkAlreadyHandled(m.getId())) { // 이미 처리했는지 확인
        continue; // 처리하지 않고 무시함
    }
    ```
    - 처리했는지 여부는 DB 테이블에 기록하거나 메모리에 Set으로 관리하면 됨 (메모리 부족 방지 위해 일정 개수 ID만 저장하도록 하기)
- (2)의 경우 4장에서 언급한 멱등성을 갖도록 API를 구현하면 됨
    - 메시지를 잘 소비하고 있는지 모니터링 잘 하는 게 중요
 ### 메시지 종류 : 이벤트와 커맨드
 - 메시지의 종류 2가지: 이벤트, 커맨드
 - `이벤트`
   - 어떤 일이 발생했음
   - 상태(데이터) 변화와 관련이 있음
   - 정해진 수신자가 없고 관심이 있는 소비자가 메시지를 수신함
   - `주문함` `로그인에 실패함` `상품 정보를 조회함` `배송을 완료함`
- `커맨드`
  - 무언가를 요청 함
  - 수신할 측의 기능 실행에 초점이 맞춰져 있음
  - `포인트 지급하기` `로그인 차단하기` `배송 완료 문자 발송하기`
- 이벤트 메시지는 소비자 확장에 적합
> 궁극적 일관성 : 일시적으로 두 저장소 간에 데이터 불일치가 발생할 수 있다
 - 
